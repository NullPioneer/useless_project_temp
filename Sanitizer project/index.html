<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snap & Track — Bottle Analyzer (Prototype)</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#ff7a18; --muted:#99a1b3; --glass: rgba(255,255,255,0.04);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:
    radial-gradient(1200px 600px at 10% 10%, rgba(255,122,24,0.06), transparent 6%),
    linear-gradient(180deg, #071026 0%, #07132a 100%);
    color:#eef2f7;}
  .app {max-width:920px; margin:28px auto; padding:18px;}
  header{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
  h1{font-size:18px;margin:0}
  .icons{margin-left:auto; display:flex; gap:10px;}
  .icon-btn{width:48px;height:48px;border-radius:12px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 6px 18px rgba(2,6,23,0.6); margin-bottom:12px;}
  #preview{width:100%;max-height:360px;object-fit:contain;border-radius:10px;border:1px dashed rgba(255,255,255,0.03); background:#071126; display:block;}
  .meta{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:10px;}
  .meta > div{flex:1;min-width:160px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#ffb068);color:#08101a;font-weight:600;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px}
  #historyList{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
  .hist-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;overflow:hidden}
  .hist-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
  .spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .muted{color:var(--muted);font-size:13px}
  .notice{font-size:13px;color:var(--muted);margin-top:8px}
  footer{margin-top:16px;color:var(--muted);font-size:13px}
  @media (max-width:520px){ .meta{flex-direction:column} header{gap:8px} .icons{gap:8px} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Snap & Track</h1>
        <div class="small">Take a photo, get product info, estimate consumption</div>
      </div>
      <div class="icons">
        <div class="icon-btn" id="cameraBtn" title="Take photo (camera)">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff"><path d="M21 19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7h5l2-2h6l2 2h5v12z" stroke-width="1.2" stroke-linejoin="round"/></svg>
        </div>
        <div class="icon-btn" id="historyBtn" title="History / Saved photos">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff"><path d="M21 8v10a2 2 0 0 1-2 2H7" stroke-width="1.2"/><path d="M3 10h4l2 2h8" stroke-width="1.2"/></svg>
        </div>
      </div>
    </header>

    <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />

    <div class="card">
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <img id="preview" alt="Preview" src="" />
        <div style="flex:1;min-width:260px">
          <label>Detected product</label>
          <div id="productName" class="muted">No photo yet</div>

          <div class="meta">
            <div>
              <label>Volume (ml)</label>
              <input id="volumeField" type="text" placeholder="e.g., 500" />
            </div>
            <div>
              <label>Height (cm)</label>
              <input id="heightField" type="number" placeholder="Manual or detect" />
            </div>
            <div>
              <label>People using</label>
              <input id="peopleField" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Times/day per person</label>
              <input id="timesField" type="number" min="1" value="3" />
            </div>
            <div>
              <label>Usage per use (ml)</label>
              <input id="usageField" type="number" min="0.1" value="3" step="0.1" />
            </div>
          </div>

          <button id="detectHeightBtn" style="margin-top:8px;background:#3ab0ff;">Detect Height from Reference</button>
          <input id="refSizeField" type="number" placeholder="Reference width in cm (e.g., 8.5)" style="margin-top:4px;width:100%" />

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="calcBtn">Calculate days remaining</button>
            <button id="saveBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">Save to history</button>
            <div id="busy" style="display:none" class="spinner" title="processing"></div>
          </div>

          <div id="resultArea" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="card" id="historyPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>History</strong><div class="small">Saved photos & details</div></div>
        <div style="display:flex;gap:8px">
          <button id="clearHistory">Clear all</button>
          <button id="closeHistory">Close</button>
        </div>
      </div>
      <div id="historyList"></div>
    </div>

    <footer>
      Prototype — MobileNet + OCR. Height detection requires clicking bottle & reference in photo.
    </footer>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.1/dist/mobilenet.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
(async function(){
  const cameraBtn = document.getElementById('cameraBtn');
  const historyBtn = document.getElementById('historyBtn');
  const cameraInput = document.getElementById('cameraInput');
  const preview = document.getElementById('preview');
  const productName = document.getElementById('productName');
  const volumeField = document.getElementById('volumeField');
  const heightField = document.getElementById('heightField');
  const peopleField = document.getElementById('peopleField');
  const timesField = document.getElementById('timesField');
  const usageField = document.getElementById('usageField');
  const calcBtn = document.getElementById('calcBtn');
  const saveBtn = document.getElementById('saveBtn');
  const busy = document.getElementById('busy');
  const resultArea = document.getElementById('resultArea');
  const historyPanel = document.getElementById('historyPanel');
  const historyList = document.getElementById('historyList');
  const closeHistory = document.getElementById('closeHistory');
  const clearHistory = document.getElementById('clearHistory');
  const detectHeightBtn = document.getElementById('detectHeightBtn');
  const refSizeField = document.getElementById('refSizeField');

  const LSKEY = 'snaptrack_history_v1';
  let clickPoints = [];
  let model = null;

  async function loadModel(){
    try { model = await mobilenet.load(); console.log('MobileNet loaded'); }
    catch(e){ console.warn('Mobilenet load failed', e); }
  }
  loadModel();

  cameraBtn.addEventListener('click', ()=> cameraInput.click());
  cameraInput.addEventListener('change', handleFile);
  historyBtn.addEventListener('click', showHistory);
  closeHistory.addEventListener('click', ()=> historyPanel.style.display='none');
  clearHistory.addEventListener('click', ()=> { if(confirm('Clear all history?')) { localStorage.removeItem(LSKEY); renderHistory(); } });
  calcBtn.addEventListener('click', calculateDays);
  saveBtn.addEventListener('click', saveToHistory);

  detectHeightBtn.addEventListener('click', () => {
    if(!preview.src) return alert('Load an image first.');
    clickPoints = [];
    alert('Click TOP & BOTTOM of bottle, then LEFT & RIGHT of reference object. Use the displayed image (it may be scaled).');
    preview.style.cursor = 'crosshair';
  });

  preview.addEventListener('click', (e) => {
    if(preview.style.cursor !== 'crosshair') return;
    const x = e.offsetX;
    const y = e.offsetY;

    const scaleX = preview.naturalWidth / preview.clientWidth;
    const scaleY = preview.naturalHeight / preview.clientHeight;

    const realX = x * scaleX;
    const realY = y * scaleY;

    clickPoints.push({x: realX, y: realY});
    if(clickPoints.length === 4){
      preview.style.cursor = 'default';
      const bottlePixelHeight = Math.abs(clickPoints[1].y - clickPoints[0].y);
      const refPixelWidth = Math.abs(clickPoints[3].x - clickPoints[2].x);
      const refSizeCm = parseFloat(refSizeField.value);
      if(!refSizeCm || refSizeCm <= 0){ alert('Enter a valid reference width in cm first.'); clickPoints=[]; clearTempMarkers(); return; }
      const pixelsPerCm = refPixelWidth / refSizeCm;
      const bottleHeightCm = (bottlePixelHeight / pixelsPerCm).toFixed(2);
      heightField.value = bottleHeightCm;
      clearTempMarkers();
      alert(`Estimated bottle height: ${bottleHeightCm} cm`);
    }
  });

  // draw temporary markers on top of the preview (simple overlay)
  const markerContainer = document.createElement('div');
  markerContainer.style.position = 'absolute';
  markerContainer.style.left = 0; markerContainer.style.top = 0; markerContainer.style.pointerEvents = 'none';
  markerContainer.id = 'markerContainer';
  document.body.appendChild(markerContainer);

  function drawTempMarker(x, y){
    clearTempMarkers();
    // place small circles for each point recorded so far
    const rect = preview.getBoundingClientRect();
    clickPoints.forEach((p, i) => {
      const el = document.createElement('div');
      el.style.position = 'absolute';
      el.style.width = '10px'; el.style.height = '10px'; el.style.borderRadius = '50%';
      el.style.background = 'rgba(255,122,24,0.9)';
      el.style.left = (rect.left + p.x - 5) + 'px';
      el.style.top = (rect.top + p.y - 5) + 'px';
      el.className = 'tmpMarker';
      markerContainer.appendChild(el);
    });
  }
  function clearTempMarkers(){ Array.from(document.querySelectorAll('.tmpMarker')).forEach(n=>n.remove()); }

  async function handleFile(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    preview.src = url;
    productName.textContent = 'Analyzing...';
    resultArea.innerHTML = '';
    busy.style.display = 'inline-block';
    clickPoints = []; clearTempMarkers();

    const img = new Image(); img.src = url; await img.decode();

    if(model){
      try {
        const predictions = await model.classify(img);
        productName.textContent = predictions[0]?.className || 'Unknown product';
      } catch(err){ productName.textContent = 'Labeling error'; console.warn(err); }
    } else productName.textContent = 'Model not loaded';

    try {
      const worker = Tesseract.createWorker({});
      await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
      const canvas = document.createElement('canvas');
      const maxw = 800; const scale = Math.min(1, maxw / img.width);
      canvas.width = Math.round(img.width * scale); canvas.height = Math.round(img.height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const { data: { text } } = await worker.recognize(canvas);
      await worker.terminate();
      const vol = parseVolumeFromText(text);
      if(vol) volumeField.value = vol;
    } catch(e){ console.warn('OCR failed', e); }

    busy.style.display = 'none';
  }

  function parseVolumeFromText(text){
    if(!text) return null;
    text = text.replace(/\s+/g,' ').toLowerCase();
    const mlMatch = text.match(/(\d{2,4})\s?ml\b/);
    if(mlMatch) return parseInt(mlMatch[1],10);
    const lMatch = text.match(/(\d+(\.\d+)?)\s?l\b/);
    if(lMatch) return Math.round(parseFloat(lMatch[1]) * 1000);
    return null;
  }

  function playBeep(frequency=800, duration=150){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.frequency.value = frequency;
    oscillator.type = 'square';
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    oscillator.start();
    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
    oscillator.stop(ctx.currentTime + duration / 1000);
    oscillator.onended = () => ctx.close();
  }

  async function calculateDays() {
    const vol = parseFloat(volumeField.value);
    const people = parseFloat(peopleField.value) || 1;
    const times = parseFloat(timesField.value) || 3;
    const usagePerUse = parseFloat(usageField.value) || 3;

    if (isNaN(vol) || vol <= 0) {
      resultArea.innerHTML = '<div class="muted">Enter product volume first</div>';
      return;
    }

    const totalDailyUse = people * times * usagePerUse;
    if (totalDailyUse <= 0) {
      resultArea.innerHTML = '<div class="muted">Invalid daily usage</div>';
      return;
    }

    const messages = [
      "Initializing nuclear core... 💥",
      "Calibrating flux capacitors... ⚡️",
      "Charging antimatter containment fields... ☢️",
      "Aligning quantum resonators... 🔄",
      "Detonator switch in 3... 2... 1... 🚀"
    ];

    calcBtn.disabled = true;
    resultArea.innerHTML = '';

    for (let i = 0; i < messages.length; i++) {
      resultArea.innerHTML = `<div style="font-weight:bold;color:#ff7a18;">${messages[i]}</div>`;
      playBeep(600 + i*100, 200);
      // Wait 1.2 seconds between messages
      await new Promise(r => setTimeout(r, 1200));
    }

    const days = Math.floor(vol / totalDailyUse);

    resultArea.innerHTML = `<div><strong>${days} days</strong> — Based on ${vol} ml, ${people} people × ${times} times/day × ${usagePerUse} ml/use.</div>`;

    calcBtn.disabled = false;
  }

  // History handling
  function saveToHistory(){
    if(!preview.src) return alert('No photo to save.');
    const item = {
      id: Date.now(),
      src: preview.src,
      product: productName.textContent,
      volume: volumeField.value,
      height: heightField.value,
      people: peopleField.value,
      times: timesField.value,
      usage: usageField.value,
      date: new Date().toISOString()
    };
    let hist = JSON.parse(localStorage.getItem(LSKEY) || '[]');
    hist.unshift(item);
    localStorage.setItem(LSKEY, JSON.stringify(hist));
    alert('Saved to history.');
  }

  function renderHistory(){
    let hist = JSON.parse(localStorage.getItem(LSKEY) || '[]');
    historyList.innerHTML = '';
    if(hist.length === 0){
      historyList.innerHTML = '<div class="muted">No saved items</div>';
      return;
    }
    for(let item of hist){
      const card = document.createElement('div');
      card.className = 'hist-card';
      card.innerHTML = `
        <img src="${item.src}" alt="Saved photo"/>
        <div><strong>${item.product}</strong></div>
        <div>Volume: ${item.volume} ml, Height: ${item.height} cm</div>
        <div>${item.people} people × ${item.times} times/day × ${item.usage} ml/use</div>
        <div class="small muted">${new Date(item.date).toLocaleString()}</div>
      `;
      historyList.appendChild(card);
    }
  }

  function showHistory(){
    renderHistory();
    historyPanel.style.display = 'block';
  }
})();
</script>

</body>
</html>
